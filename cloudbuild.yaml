substitutions:
  _SERVICE_NAME: python-web-app
  _REGION: us-west1
  _AR_REPO: gke-repo
  # üîë FIX: Add a custom tag variable. 
  # This default will be used for manual runs if nothing else is provided.
  _TAG: 'latest' 

steps:
# 1. Build the Docker image
- name: 'gcr.io/cloud-builders/docker'
  id: Build
  args:
    - 'build'
    - '-t'
    # ‚ùå OLD: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA:-latest}
    # ‚úÖ NEW: Use the simple _TAG variable
    - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${_TAG}'
    - '--file=Dockerfile'
    - '.'

# 2. Push the image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  id: Push
  args:
    - 'push'
    # ‚úÖ NEW: Use the simple _TAG variable
    - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${_TAG}'

# 3. Deploy to Cloud Run
- name: 'gcr.io/cloud-builders/gcloud'
  id: Deploy
  args:
    - run
    - deploy
    - ${_SERVICE_NAME}
    # ‚úÖ NEW: Use the simple _TAG variable
    - --image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${_TAG}
    - --region=${_REGION}
    - --platform=managed
    - --allow-unauthenticated
    - --project=${PROJECT_ID}
  waitFor: ['Push']

images:
# ‚úÖ NEW: Use the simple _TAG variable
- '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${_TAG}'

options:
  logging: CLOUD_LOGGING_ONLY